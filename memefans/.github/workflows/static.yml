name: Deploy static content to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: |
          npm install markdown-it markdown-it-mermaid @mermaid-js/mermaid-cli

      - name: Create HTML Templates
        run: |
          # Create header template
          echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MEMEFANS Documentation</title><script>(function(){var p=window.location.pathname;if(p.includes("/twitter-token-plugin/")){window.location.href=window.location.protocol+"//"+window.location.host+p.replace("/twitter-token-plugin/","/memefans/")}})()</script><style>body{font-family:system-ui,-apple-system,sans-serif;line-height:1.6;max-width:800px;margin:0 auto;padding:20px}pre{background:#f6f8fa;padding:16px;overflow:auto}code{font-family:monospace}.mermaid{background:#fff;padding:10px;border-radius:5px}nav{margin-bottom:30px}nav a{margin-right:15px;color:#0366d6;text-decoration:none}nav a:hover{text-decoration:underline}</style><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true,theme:"default",flowchart:{useMaxWidth:true}})</script></head><body><nav><a href="/memefans/quick-start.html">Quick Start</a><a href="/memefans/use-cases-detailed.html">Use Cases</a><a href="/memefans/permission-justification.html">Permissions</a><a href="/memefans/privacy-policy.html">Privacy</a><a href="/memefans/SUPPORT.html">Support</a></nav>' > header.html
          
          # Create footer template
          echo '</body></html>' > footer.html
          
          # Create index.html
          echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MEMEFANS Documentation</title><script>(function(){var p=window.location.pathname;if(p.includes("/twitter-token-plugin/")){window.location.href=window.location.protocol+"//"+window.location.host+p.replace("/twitter-token-plugin/","/memefans/")}else if(p==="/memefans/"||p==="/memefans/index.html"){window.location.href=window.location.protocol+"//"+window.location.host+"/memefans/quick-start.html"}})()</script><meta http-equiv="refresh" content="0;url=/memefans/quick-start.html"><style>body{font-family:system-ui,-apple-system,sans-serif;text-align:center;padding:20px}</style></head><body><h1>MEMEFANS Documentation</h1><p>Redirecting to <a href="/memefans/quick-start.html">Quick Start Guide</a>...</p></body></html>' > index.html
          
          # Create 404.html
          echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Page Not Found - MEMEFANS</title><script>(function(){var p=window.location.pathname;if(p.includes("/twitter-token-plugin/")){window.location.href=window.location.protocol+"//"+window.location.host+p.replace("/twitter-token-plugin/","/memefans/")}})()</script><style>body{font-family:system-ui,-apple-system,sans-serif;text-align:center;padding:20px;max-width:600px;margin:0 auto}h1{margin-top:40px}.back-link{margin-top:20px}a{color:#0366d6;text-decoration:none}a:hover{text-decoration:underline}</style></head><body><h1>Page Not Found</h1><p>The page you are looking for does not exist or has been moved.</p><p class="back-link"><a href="/memefans/quick-start.html">Go to Quick Start Guide</a></p></body></html>' > 404.html

      - name: Build Site
        run: |
          mkdir -p _site
          
          # Copy HTML templates
          cp index.html _site/
          cp 404.html _site/
          
          # Copy and convert markdown files
          if [ -d "docs" ]; then
            cp -r docs/* _site/ || true
          fi
          
          # Convert markdown files
          for file in _site/*.md; do
            if [ -f "$file" ]; then
              html_file="${file%.md}.html"
              echo "Converting $file to $html_file"
              cat header.html > "$html_file"
              npx markdown-it --use markdown-it-mermaid "$file" >> "$html_file"
              cat footer.html >> "$html_file"
              rm "$file"
            fi
          done
          
          # Create .nojekyll file
          touch _site/.nojekyll
          
          # List generated files
          ls -la _site/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
