name: Deploy static content to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: |
          npm install markdown-it markdown-it-mermaid @mermaid-js/mermaid-cli

      - name: Clean Build Directory
        run: |
          rm -rf _site
          mkdir -p _site/memefans
          # Create .nojekyll file
          touch _site/.nojekyll

      - name: Create HTML Templates
        run: |
          # Create header template with base URL
          echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><base href="/memefans/"><title>MEMEFANS Documentation</title><style>body{font-family:system-ui,-apple-system,sans-serif;line-height:1.6;max-width:800px;margin:0 auto;padding:20px}pre{background:#f6f8fa;padding:16px;overflow:auto}code{font-family:monospace}.mermaid{background:#fff;padding:10px;border-radius:5px}nav{margin-bottom:30px}nav a{margin-right:15px;color:#0366d6;text-decoration:none}nav a:hover{text-decoration:underline}</style><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize({startOnLoad:true,theme:"default",flowchart:{useMaxWidth:true}})</script></head><body><nav><a href="quick-start.html">Quick Start</a><a href="use-cases-detailed.html">Use Cases</a><a href="permission-justification.html">Permissions</a><a href="privacy-policy.html">Privacy</a><a href="SUPPORT.html">Support</a></nav>' > header.html
          
          # Create footer template
          echo '</body></html>' > footer.html

      - name: Build Site
        run: |
          # Create output directory
          mkdir -p _site/memefans
          
          # Process markdown files
          for file in docs/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              outfile="_site/memefans/${filename}.html"
              
              # Combine header, converted markdown, and footer
              cat header.html > "$outfile"
              npx markdown-it "$file" >> "$outfile"
              cat footer.html >> "$outfile"
            fi
          done
          
          # Create index.html that redirects to quick-start
          echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><base href="/memefans/"><title>MEMEFANS Documentation</title><meta http-equiv="refresh" content="0;url=quick-start.html"><style>body{font-family:system-ui,-apple-system,sans-serif;text-align:center;padding:20px}</style></head><body><h1>MEMEFANS Documentation</h1><p>Redirecting to <a href="quick-start.html">Quick Start Guide</a>...</p></body></html>' > _site/memefans/index.html
          
          # Create 404 page with base URL
          echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><base href="/memefans/"><title>Page Not Found - MEMEFANS</title><style>body{font-family:system-ui,-apple-system,sans-serif;text-align:center;padding:20px;max-width:600px;margin:0 auto}h1{margin-top:40px}.back-link{margin-top:20px}a{color:#0366d6;text-decoration:none}a:hover{text-decoration:underline}</style></head><body><h1>Page Not Found</h1><p>The page you are looking for does not exist or has been moved.</p><p class="back-link"><a href="quick-start.html">Go to Quick Start Guide</a></p></body></html>' > _site/memefans/404.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
