# Simple workflow for deploying static content to GitHub Pages
name: Deploy static content to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Single deploy job since we're just deploying
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: |
          npm install markdown-it markdown-it-mermaid @mermaid-js/mermaid-cli

      - name: Build Site
        run: |
          mkdir -p _site
          
          if [ -d "docs" ]; then
            cp -r docs/* _site/ || true
          fi
          
          for file in _site/*.md; do
            if [ -f "$file" ]; then
              html_file="${file%.md}.html"
              echo "Converting $file to $html_file"
              
              {
                echo '<!DOCTYPE html>'
                echo '<html>'
                echo '<head>'
                echo '    <meta charset="UTF-8">'
                echo '    <meta name="viewport" content="width=device-width, initial-scale=1">'
                echo '    <title>MEMEFANS Documentation</title>'
                echo '    <script>'
                echo '        // Check if we are on the wrong domain'
                echo '        if (window.location.href.includes("/twitter-token-plugin/")) {'
                echo '            window.location.href = window.location.href.replace("/twitter-token-plugin/", "/memefans/");'
                echo '        }'
                echo '    </script>'
                echo '    <style>'
                echo '        body {'
                echo '            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;'
                echo '            line-height: 1.6;'
                echo '            max-width: 800px;'
                echo '            margin: 0 auto;'
                echo '            padding: 20px;'
                echo '        }'
                echo '        pre { background: #f6f8fa; padding: 16px; overflow: auto; }'
                echo '        code { font-family: "SFMono-Regular", Consolas, monospace; }'
                echo '        .mermaid { background: #fff; padding: 10px; border-radius: 5px; }'
                echo '    </style>'
                echo '    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>'
                echo '    <script>'
                echo '        mermaid.initialize({'
                echo '            startOnLoad: true,'
                echo '            theme: "default",'
                echo '            flowchart: { useMaxWidth: true }'
                echo '        });'
                echo '    </script>'
                echo '</head>'
                echo '<body>'
              } > "$html_file"
              
              npx markdown-it --use markdown-it-mermaid "$file" >> "$html_file"
              echo '</body></html>' >> "$html_file"
              rm "$file"
            fi
          done
          
          {
            echo '<!DOCTYPE html>'
            echo '<html>'
            echo '<head>'
            echo '    <meta charset="UTF-8">'
            echo '    <meta name="viewport" content="width=device-width, initial-scale=1">'
            echo '    <title>MEMEFANS Documentation</title>'
            echo '    <script>'
            echo '        // Check if we are on the wrong domain'
            echo '        if (window.location.href.includes("/twitter-token-plugin/")) {'
            echo '            window.location.href = window.location.href.replace("/twitter-token-plugin/", "/memefans/");'
            echo '        }'
            echo '    </script>'
            echo '    <meta http-equiv="refresh" content="0; url=use-cases-detailed.html">'
            echo '</head>'
            echo '<body>'
            echo '    <h1>MEMEFANS Documentation</h1>'
            echo '    <p>Redirecting to <a href="use-cases-detailed.html">documentation</a>...</p>'
            echo '</body>'
            echo '</html>'
          } > _site/index.html
          
          touch _site/.nojekyll
          ls -la _site/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
